# ============================================================
# PIPELINE CI/CD - Proyecto Flask (ProjectoAPIREST)
# ============================================================

trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  projectFolder: 'ProjectoAPIREST'    # üëà nombre exacto de tu carpeta
  artifactName: 'build_artifact'

steps:
# ============================================================
# 1Ô∏è‚É£ Verificar estructura de archivos
# ============================================================
- script: |
    echo "üìÅ Directorio actual:"
    pwd
    echo "üìÇ Contenido del repositorio:"
    ls -la
  displayName: 'Verificar contenido ra√≠z del repo'

# ============================================================
# 2Ô∏è‚É£ Usar Python 3.10
# ============================================================
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.10'
  displayName: 'Usar Python 3.10'

# ============================================================
# 3Ô∏è‚É£ Instalar dependencias del sistema
# ============================================================
- script: |
    sudo apt-get update -y
    sudo apt-get install -y build-essential libssl-dev libffi-dev python3-dev
  displayName: 'Instalar dependencias del sistema'

# ============================================================
# 4Ô∏è‚É£ Instalar dependencias Python del proyecto Flask
# ============================================================
- script: |
    echo "üì¶ Entrando en carpeta del proyecto: $(projectFolder)"
    cd $(projectFolder)
    echo "üìÇ Archivos dentro de la carpeta:"
    ls -la
    python -m pip install --upgrade pip setuptools wheel
    pip install -r requirements.txt
  displayName: 'Instalar dependencias Python'

# ============================================================
# 5Ô∏è‚É£ Levantar la app Flask (modo prueba con SQLite)
# ============================================================
- script: |
    cd $(projectFolder)
    echo "üöÄ Iniciando API Flask..."
    export DATABASE_URL="sqlite:///test.db"
    python -u app.py > ../app_stdout.log 2> ../app_stderr.log &
    echo $! > ../app.pid
    sleep 5
    echo "‚úÖ Flask levantado."
  displayName: 'Levantar Flask'

# ============================================================
# 6Ô∏è‚É£ Ejecutar pruebas autom√°ticas
# ============================================================
- script: |
    cd $(projectFolder)
    echo "üß™ Ejecutando pruebas autom√°ticas..."
    python Test_api.py
  displayName: 'Ejecutar Test_api.py'

# ============================================================
# 7Ô∏è‚É£ Detener Flask
# ============================================================
- script: |
    if [ -f app.pid ]; then
      echo "üõë Deteniendo Flask..."
      kill $(cat app.pid)
      rm -f app.pid
    else
      echo "‚ö† No se encontr√≥ app.pid"
    fi
  displayName: 'Detener aplicaci√≥n Flask'

# ============================================================
# 8Ô∏è‚É£ Empaquetar aplicaci√≥n en ZIP
# ============================================================
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)/$(projectFolder)'
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
    replaceExistingArchive: true
  displayName: 'Empaquetar proyecto en ZIP'

# ============================================================
# 9Ô∏è‚É£ Publicar artifact
# ============================================================
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
  displayName: 'Publicar artifact'